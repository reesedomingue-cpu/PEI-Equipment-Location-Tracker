<div style="max-width:500px; margin:auto; font-family:Segoe UI, sans-serif; text-align:center;">
  <h1 style="font-size:2.5em; margin-bottom:30px;">Equipment Location Update</h1>

  <form id="locationForm">
    <label for="unitNumber" style="font-size:1.8em;">Unit Number:</label><br>
    <input type="text" id="unitNumber" name="unitNumber" readonly 
           style="width:100%; padding:20px; font-size:1.8em; margin-top:10px; margin-bottom:30px; text-align:center;"><br>

    <button type="submit" 
            style="padding:25px 40px; font-size:2em; background-color:#0078D7; color:white; border:none; border-radius:12px; cursor:pointer;">
      Submit
    </button>
  </form>
</div>

<script>
  // Prefill Unit Number from URL
  const params = new URLSearchParams(window.location.search);
  const unitInput = document.getElementById('unitNumber');
  if(params.has('unit')) {
    unitInput.value = params.get('unit');
  }

  const form = document.getElementById('locationForm');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!navigator.geolocation) {
      alert("Geolocation not supported by this browser.");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      async function(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        const data = {
          unitNumber: unitInput.value,
          latitude: latitude,
          longitude: longitude
        };

        try {
          const response = await fetch("https://defaultf4ae40429a0a4e568a37357921900e.7e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/247fa41316c04ec49b1a3baa48ee5ec9/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=xpTLQQj1dnUYTJSeZY4blWWErtoEv5YEjwPUYTWj8XY", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });

          if(response.ok){
            alert("Location submitted successfully!");
          } else {
            alert("Error submitting location. Please try again.");
          }
        } catch(err) {
          alert("Error submitting location: " + err);
        }

      },
      function(error) {
        let message = "";
        switch (error.code) {
          case error.PERMISSION_DENIED:
            message = "Location permission denied. Please allow location access.";
            break;
          case error.POSITION_UNAVAILABLE:
            message = "Location unavailable. Try moving outdoors.";
            break;
          case error.TIMEOUT:
            message = "Location request timed out. Try again.";
            break;
          default:
            message = "Unknown location error.";
        }
        alert(message);
      },
      { enableHighAccuracy: true, timeout:15000, maximumAge:0 }
    );
  });
</script>
